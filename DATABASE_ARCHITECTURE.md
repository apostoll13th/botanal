# üóÑÔ∏è Database Architecture

## –ö—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å—Ö–µ–º—É –ë–î?

### ‚úÖ Python Bot - –í–õ–ê–î–ï–õ–ï–¶ —Å—Ö–µ–º—ã

**bot.py** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

```python
# 1. –ñ–¥–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL
wait_for_db()

# 2. –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
init_db()

# 3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
check_and_update_database()
```

**–°–æ–∑–¥–∞–≤–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `expenses` - —Ä–∞—Å—Ö–æ–¥—ã
- `budgets` - –±—é–¥–∂–µ—Ç—ã
- `savings_goals` - —Ü–µ–ª–∏ —ç–∫–æ–Ω–æ–º–∏–∏
- `reminders` - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `migrations` - –∏—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### üî∑ Go Backend - –ß–ò–¢–ê–¢–ï–õ–¨

**backend-go/main.go** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

```go
// 1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ë–î
db.Open(databaseURL)

// 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
checkTablesExist()

// 3. –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü –Ω–µ—Ç - –∂–¥–µ—Ç (–¥–æ 30 —Å–µ–∫—É–Ω–¥)
// 4. –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç API —Å–µ—Ä–≤–µ—Ä
```

**Go backend –ù–ï —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã!**

–û–Ω —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ SELECT –∑–∞–ø—Ä–æ—Å—ã.

## üîÑ –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ (docker-compose.yml)

```yaml
services:
  db:         # 1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
    image: postgres:15-alpine

  bot:        # 2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ db
    depends_on:
      - db
    # –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

  backend:    # 3. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ bot
    depends_on:
      - db
      - bot   # ‚Üê –í–∞–∂–Ω–æ!
    # –ñ–¥–µ—Ç –ø–æ–∫–∞ bot —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã

  frontend:   # 4. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º
    depends_on:
      - backend
```

## ‚è±Ô∏è –¢–∞–π–º–ª–∞–π–Ω –∑–∞–ø—É—Å–∫–∞

```
0s    ‚Üí PostgreSQL —Å—Ç–∞—Ä—Ç—É–µ—Ç
2s    ‚Üí PostgreSQL –≥–æ—Ç–æ–≤
3s    ‚Üí Bot —Å—Ç–∞—Ä—Ç—É–µ—Ç
5s    ‚Üí Bot —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
6s    ‚Üí Backend —Å—Ç–∞—Ä—Ç—É–µ—Ç
7s    ‚Üí Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã ‚úÖ
8s    ‚Üí Backend API –≥–æ—Ç–æ–≤
10s   ‚Üí Frontend —Å—Ç–∞—Ä—Ç—É–µ—Ç
12s   ‚Üí –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞
```

## üîß –ó–∞—â–∏—Ç–∞ –æ—Ç race condition

### –ü—Ä–æ–±–ª–µ–º–∞:
–ï—Å–ª–∏ backend —Å—Ç–∞—Ä—Ç—É–µ—Ç –±—ã—Å—Ç—Ä–µ–µ bot, —Ç–∞–±–ª–∏—Ü –µ—â–µ –Ω–µ—Ç!

### –†–µ—à–µ–Ω–∏–µ 1: depends_on
```yaml
backend:
  depends_on:
    - bot  # Backend —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø–æ—Å–ª–µ bot
```

### –†–µ—à–µ–Ω–∏–µ 2: checkTablesExist()
```go
// Backend –∂–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü (–¥–æ 30 —Å–µ–∫)
for i := 0; i < 10; i++ {
    if checkTablesExist() {
        return // –¢–∞–±–ª–∏—Ü—ã –Ω–∞–π–¥–µ–Ω—ã!
    }
    time.Sleep(3 * time.Second)
}
```

## üìä –ú–∏–≥—Ä–∞—Ü–∏–∏

### Python (database_migrations.py)

```python
class DatabaseMigration:
    def run_migrations(self):
        # Migration 1: add user_name to expenses
        # Migration 2: add user_name to budgets
        # Migration 3: add user_name to savings_goals
        # Migration 4: add description to expenses
        # Migration 5: add goal_name to savings_goals
```

**–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π:**
```sql
SELECT * FROM migrations;
-- version | description              | applied_at
-- 1       | Add user_name to expenses | 2024-11-09 12:00:00
-- 2       | Add user_name to budgets  | 2024-11-09 12:00:01
```

### Go Backend
**–ù–ï –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏** - —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å—Ö–µ–º—É.

## üéØ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü | –ú–∏–≥—Ä–∞—Ü–∏–∏ | –ß—Ç–µ–Ω–∏–µ | –ó–∞–ø–∏—Å—å |
|-----------|----------------|----------|---------|---------|
| **Bot (Python)** | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| **Backend (Go)** | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |
| **Frontend (React)** | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç |

## üí° –ó–∞—á–µ–º —Ç–∞–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞?

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **Single Source of Truth**
   - –¢–æ–ª—å–∫–æ bot —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ö–µ–º–æ–π –ë–î
   - –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
   - –ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - Backend –∏–º–µ–µ—Ç read-only –ª–æ–≥–∏–∫—É
   - –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π

3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**
   - Backend –Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
   - Backend –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
   - –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ read-only —Å–µ—Ä–≤–∏—Å—ã

## üîÆ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã backend —Ç–æ–∂–µ –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ö–µ–º—É:

### –í–∞—Ä–∏–∞–Ω—Ç A: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```go
// –í main.go
func runMigrations() {
    // CREATE TABLE IF NOT EXISTS expenses...
    // CREATE TABLE IF NOT EXISTS budgets...
}
```

**–ú–∏–Ω—É—Å—ã:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–∏–≥—Ä–∞—Ü–∏–π
- –°–ª–æ–∂–Ω–µ–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
- –†–∏—Å–∫ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Å—Ö–µ–º

### –í–∞—Ä–∏–∞–Ω—Ç B: –û–±—â–∏–π init –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
```yaml
services:
  db-init:  # –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
    build: ./db-migrations
    depends_on:
      - db

  bot:
    depends_on:
      - db-init

  backend:
    depends_on:
      - db-init
```

**–ú–∏–Ω—É—Å—ã:**
- –£—Å–ª–æ–∂–Ω—è–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –ï—â–µ –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

### –í–∞—Ä–∏–∞–Ω—Ç C: Migration tool (golang-migrate)
```bash
migrate -database $DATABASE_URL -path ./migrations up
```

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –≤ SQL —Ñ–∞–π–ª–∞—Ö
- Rollback –ø–æ–¥–¥–µ—Ä–∂–∫–∞

## üé¨ –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä

**–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥—Ö–æ–¥: Bot owns schema**

–ü–æ—á–µ–º—É:
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞
- ‚úÖ –û–¥–∏–Ω –≤–ª–∞–¥–µ–ª–µ—Ü —Å—Ö–µ–º—ã
- ‚úÖ Backend read-only = –±–µ–∑–æ–ø–∞—Å–Ω–æ
- ‚úÖ –õ–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ bot —Å–æ–∑–¥–∞–ª —Ç–∞–±–ª–∏—Ü—ã:
```bash
docker compose exec db psql -U postgres -d expenses -c "\dt"

# –í—ã–≤–æ–¥:
#             List of relations
#  Schema |     Name      | Type  |  Owner
# --------+---------------+-------+----------
#  public | budgets       | table | postgres
#  public | expenses      | table | postgres
#  public | migrations    | table | postgres
#  public | reminders     | table | postgres
#  public | savings_goals | table | postgres
#  public | users         | table | postgres
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
docker compose exec db psql -U postgres -d expenses -c "SELECT * FROM migrations;"

# –í—ã–≤–æ–¥ –≤–µ—Ä—Å–∏–π –º–∏–≥—Ä–∞—Ü–∏–π
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ backend –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:
```bash
docker compose logs backend | grep "Successfully connected"

# –í—ã–≤–æ–¥:
# ‚úÖ Successfully connected to database
# ‚úÖ Database tables found
```

---

**–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω:** 2024-11-09
